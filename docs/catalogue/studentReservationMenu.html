<!DOCTYPE HTML>
<html>
    <head>
        <title>Student Reservation</title>
        <link href="https://aarif123456.github.io/HogwartsLibrary/styles/bootstrap.css" rel="stylesheet" type="text/css" media="all">
        <link href="https://aarif123456.github.io/HogwartsLibrary/styles/main.css" rel="stylesheet" type="text/css" media="all" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="Hogwarts stuff" />
        <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700,900' rel='stylesheet' type='text/css'>
        <!--<link href='https://fonts.googleapis.com/css?family=Alice' rel='stylesheet' type='text/css'>-->
        <script src="https://aarif123456.github.io/HogwartsLibrary/scripts/jquery/jquery.min.js"></script>
        <script src="https://aarif123456.github.io/HogwartsLibrary/scripts/jquery/jquery.easydropdown.js"></script>
        <link rel="stylesheet" href="https://aarif123456.github.io/HogwartsLibrary/styles/swipebox.css">
        <!------ Light Box ------>
        <script src="https://aarif123456.github.io/HogwartsLibrary/scripts/jquery/jquery.swipebox.min.js"></script> 
        <script type="text/javascript">
            jQuery(function($) {
            	$(".swipebox").swipebox();
            });
        </script>
        <!------ Eng Light Box ------>
        <script type="text/javascript" src="https://aarif123456.github.io/HogwartsLibrary/scripts/imported/easing.js"></script>
        <script type="text/javascript">
            jQuery(document).ready(function($) {
            	$(".scroll").click(function(event){		
            		event.preventDefault();
            		$('html,body').animate({scrollTop:$(this.hash).offset().top},1200);
            	});
            });
        </script>
        <input type="hidden" id="pageNum" value="5" >
        <input type="hidden" id="pageCategory" value="catalogue" >
        <script src="https://aarif123456.github.io/HogwartsLibrary/scripts/loadCommon.js"></script> 
	<link rel="stylesheet" type="text/css" href="https://aarif123456.github.io/HogwartsLibrary/styles/table.css">
	<script src="https://aarif123456.github.io/HogwartsLibrary/scripts/search.js"> </script> 
	<link rel="stylesheet" type="text/css" href="https://aarif123456.github.io/HogwartsLibrary/styles/table.css">
  <script>
    //Abdullah Arif
    //Handle student reservation
    var reservationList={};
    function loadReserveList(getList,listName){ //use Ajax to create needed list
      var xmlhttp = new XMLHttpRequest();
      var courseID=document.getElementById("courseSelection").value.trim();
      //use to work with librarian reservation
      
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          try {
            if(this.responseText.trim()=="No rows"){
              getList(this.responseText.trim());
            }
            else{
              getList(JSON.parse(this.responseText));
            }
          }
          catch (e) {
            console.log(this.responseText);
            console.log(e);
            console.log(listName);
          }
        }
      }
      xmlhttp.open('POST',"https://arif115.myweb.cs.uwindsor.ca/60334/projects/reservationList", true);
      xmlhttp.withCredentials = true;
      xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xmlhttp.send("listType="+listName+"&courseID="+courseID);
    }
    function getStudentCourses(courseJSON){
      if(courseJSON=="No rows"){
         courseListText=`This student is not enrolled in any courses
        <input type="hidden" id="courseSelection" value="-1" >`;
      }
      else{ 
        var courseListText=`<select id='courseSelection' form='reservationForm' 
        onchange="renderCurrentReservation(false);">`;
        for (course of courseJSON){
          //set course's ID as value
          courseListText +="<option value = '" + course['courseID'] + "'>" ;
          //display Id and Name in selection
          courseListText +=  course['courseID']+":     " + course["courseName"];
          courseListText += "</option> ";
        }
        courseListText += "</select> <br> </div>";
      }
      document.getElementById("courseMenu").innerHTML =courseListText;
      renderCurrentReservation(false);

    }

    function getCurrentReservation(bookJSON){
      var courseID=document.getElementById("courseSelection").value.trim();
      if(bookJSON=="No rows"){
        //don't let user try delete if there are no books reserved
        reservationList[courseID] = `This course does not have any books reserved`;
      }
      else{
        var bookISBNText = `<label for="bookISBNSelection" >Books reserved for course: </label>
        <select id='bookISBNSelection' form = 'reservationForm'>`;
        for (book of bookJSON){
          bookISBNText +="<option value = '" + book['bookISBN'] + "'>" ;
            //display Id and Name in selection
            bookISBNText +=  book["bookName"];
            if(book["author"]!="Unknown"){ //if author is Unknown then we don't need display it
              bookISBNText += " by " + book["author"];
            }
            bookISBNText += " -  reserved "+  book["numCopies"] +" copies";
            bookISBNText += "</option> ";
          }
          bookISBNText += "</select> <br> </div>";
          reservationList[courseID] = bookISBNText;
        }
        renderCurrentReservation(false);
    }

    function renderCurrentReservation(update){
      var courseID=document.getElementById("courseSelection").value.trim();
      if(courseID==-1){
        return;
      }
      if(update || reservationList[courseID]==undefined ){
        loadReserveList(getCurrentReservation,"loadReservedBooks");
      }
      else{
        var holdButton=document.getElementById("holdButton");
        try {
          if(reservationList[courseID]=="This course has no books reserved"){
            holdButton.style.display = "none";
          }
          else{
            holdButton.style.display = "inline";
          }
          document.getElementById("bookISBNMenu").innerHTML =reservationList[courseID] ;
        }
          catch(e){ //if menu is gone
          console.log(e);
          //console.log(reservationList[courseID]);
          }
      }
    }
    window.addEventListener('DOMContentLoaded', (event) => {
       loadReserveList(getStudentCourses,"loadCourses");
    });
    function holdReservation(){
        //var userID=document.getElementById("borrowedBy").value.trim();
        //create parameter to send to server side
        var bookISBN =document.getElementById("bookISBNSelection").value.trim();
        var courseID =document.getElementById("courseSelection").value.trim();
        var par = "courseID"+courseID+"&bookISBN="+bookISBN;

        //Ajax insert
        var xmlhttp = new XMLHttpRequest();
        var url="https://arif115.myweb.cs.uwindsor.ca/60334/projects/holdBooks";
        xmlhttp.open('POST', url, true);
        xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            console.log( this.responseText);
            document.getElementById("hint").innerHTML = this.responseText;
            //loadPotentialBorrower();
          }
        }
        xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlhttp.withCredentials = true;
        
        xmlhttp.send(par); 
        //clear fields
    }
  </script>
 <!-- create dashboard with function pass in checkout as location-->
</head> 
<body> 
	<div class="banner">
    <div class="header">
      <div class="container">
        <div class="head-bann">
          <div class="logo">
            <a href="https://aarif123456.github.io/HogwartsLibrary/"><img src="https://aarif123456.github.io/HogwartsLibrary/resources/images/logo.png" class="img-responsive" alt="" /></a>
          </div>
          <div class="head-part">
            <ul>
                <li><a href="https://aarif123456.github.io/HogwartsLibrary/docs/home/register">Signup</a></li>
                <!-- add in link to register**-->
                <li><a href="https://aarif123456.github.io/HogwartsLibrary/docs/catalogue/signin">Login</a></li>
                <div class="clearfix"> </div>
            </ul>
          </div>  
          <div class="clearfix"> </div>
        </div>
        <!-- start userMenu -->
        <div class="userMenu">
          <a class="toggleMenu" href="">Menu</a>
          <ul class="nav">
            
          </ul>
          <script type="text/javascript" src="https://aarif123456.github.io/HogwartsLibrary/scripts/imported/nav.js"></script>
        </div>
        <!-- end userMenu -->
      </div>
    </div> 
    <div class="banner-info1">  
      <div class="banner-col">
      </div>

      <div class="container">

      </div>
    </div>
  </div>
  <label for="courseSelection" >Courses:</label>
  <div id="courseMenu"> 
    <select id='courseSelection' form='reservationForm' onchange="displayForm();">
      <option value ="0"></option>
    </select>
  </div>
  <form autocomplete="off" name="reservationForm" id="reservationForm" onsubmit="return false;">
        <div id="bookISBNMenu"></div>
        <br>
		<button type="button" id="holdButton" onclick="holdReservation();">Hold book!</button>
    </form> <div id="hint"></div>
</body>
<div id="commonFooter"></div>
</html> 
